<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Profesional con IA - Examen de Conducir Argentina</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body { font-family: 'Roboto', sans-serif; background-color: #f0f4f8; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background-color: #ffffff; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); width: 100%; max-width: 800px; padding: 30px; box-sizing: border-box; }
        .header { text-align: center; border-bottom: 2px solid #00a1b2; padding-bottom: 20px; margin-bottom: 20px; }
        .header h1 { color: #005a7d; margin: 0; }
        #start-screen, #results-container { text-align: center; }
        #start-screen p { font-size: 1.1em; line-height: 1.6; }
        #start-btn, #restart-btn { background-color: #00a1b2; color: white; border: none; padding: 15px 30px; font-size: 1.2em; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; margin-top: 20px; }
        #start-btn:hover, #restart-btn:hover { background-color: #007b8a; }
        #quiz-container { display: none; }
        #question-counter { font-size: 1em; font-weight: 500; color: #555; margin-bottom: 15px; }
        #image-container { min-height: 200px; max-height: 250px; display: flex; justify-content: center; align-items: center; margin: 15px auto; border: 1px dashed #ccc; border-radius: 8px; padding: 10px; display: none; }
        #image-container svg { max-width: 100%; max-height: 200px; }
        #loading-indicator { font-style: italic; color: #007b8a; }
        #question-text { font-size: 1.4em; font-weight: 700; margin-bottom: 25px; }
        #answer-options { display: flex; flex-direction: column; gap: 15px; }
        .option { background-color: #f8f9fa; border: 2px solid #dee2e6; padding: 15px; border-radius: 5px; cursor: pointer; transition: all 0.2s; text-align: left; }
        .option.disabled { pointer-events: none; opacity: 0.7; }
        .option:hover:not(.disabled) { background-color: #e9ecef; border-color: #00a1b2; }
        .option.selected { background-color: #d1ecf1; border-color: #007b8a; font-weight: 500; }
        #results-container { display: none; }
        #score-text { font-size: 2.5em; font-weight: 700; margin-bottom: 20px; }
        .score-pass { color: #28a745; }
        .score-fail { color: #dc3545; }
        #review-list { list-style: none; padding: 0; text-align: left; max-height: 400px; overflow-y: auto; }
        #review-list li { background-color: #f8f9fa; border-radius: 5px; padding: 15px; margin-bottom: 10px; border-left: 5px solid; }
        #review-list li.correct { border-color: #28a745; }
        #review-list li.incorrect { border-color: #dc3545; }
        .question-review { font-weight: bold; margin-bottom: 8px; }
        .answer-review { margin-top: 8px; }
        .review-image-container { max-width: 150px; margin-top: 10px; }
        .review-image-container svg { width: 100%; height: auto; border-radius: 5px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Simulador Profesional con IA - Examen de Conducir</h1>
            <p>Basado en el Curso Nacional de Educación Vial Digital</p>
        </div>
        <div id="start-screen">
            <h2>¡Listo para practicar!</h2>
            <p>
                Este examen consta de 40 preguntas aleatorias de un banco de más de 80. Las imágenes se generarán al instante usando la IA de Gemini.
                <br><b>El sistema recordará las preguntas que ya has visto para no repetirlas.</b>
                <br>¡Mucha suerte!
            </p>
            <button id="start-btn">Comenzar Examen</button>
        </div>
        <div id="quiz-container">
            <div id="question-counter"></div>
            <div id="image-container">
                <div id="loading-indicator" style="display: none;"></div>
            </div>
            <div id="question-text"></div>
            <div id="answer-options"></div>
        </div>
        <div id="results-container">
            <h2>Resultados del Examen</h2>
            <div id="score-text"></div>
            <p id="score-message"></p>
            <h3>Revisión de Respuestas</h3>
            <ul id="review-list"></ul>
            <button id="restart-btn">Intentar Nuevo Examen</button>
        </div>
    </div>
<script>
    // Banco de preguntas completo
    const allQuestions = [
        {
            question: "La señal que se muestra, ¿qué indica?",
            prompt: "A 'Contramano' (No Entry) traffic sign. It should be a red circle with a white horizontal rectangle in the center. Argentinian road sign style.",
            options: ["Giro obligatorio", "Prohibición de avanzar (Contramano)", "Calle sin salida", "Estacionamiento exclusivo"],
            correctAnswer: "Prohibición de avanzar (Contramano)"
        },
        {
            question: "Al ver esta señal octogonal en una esquina, ¿qué debe hacer?",
            prompt: "A 'PARE' (STOP) traffic sign. It must be a red octagon with the word 'PARE' in bold, white, sans-serif letters in the center. Argentinian road sign style.",
            options: ["Disminuir la velocidad y ceder el paso", "Tener precaución por cruce de peatones", "Detener completamente la marcha y luego avanzar", "Continuar con la misma velocidad"],
            correctAnswer: "Detener completamente la marcha y luego avanzar"
        },
        // ... (Aquí iría el resto del array 'allQuestions' completo, con más de 80 preguntas. Lo omito por brevedad pero debe estar aquí)
        {
            question: "Si un semáforo cambia de verde a amarillo, usted debe:",
            options: ["Acelerar para cruzar antes de que se ponga en rojo", "Detenerse, si es posible hacerlo con seguridad, antes de la línea de cruce", "Continuar la marcha normalmente", "Frenar bruscamente sin importar el vehículo de atrás"],
            correctAnswer: "Detenerse, si es posible hacerlo con seguridad, antes de la línea de cruce"
        }
    ];

    // --- LÓGICA DEL FRONT-END ---
    const startScreen = document.getElementById('start-screen');
    const quizContainer = document.getElementById('quiz-container');
    const resultsContainer = document.getElementById('results-container');
    const startBtn = document.getElementById('start-btn');
    const restartBtn = document.getElementById('restart-btn');

    const questionCounterElem = document.getElementById('question-counter');
    const imageContainerElem = document.getElementById('image-container');
    const loadingIndicatorElem = document.getElementById('loading-indicator');
    const questionTextElem = document.getElementById('question-text');
    const answerOptionsElem = document.getElementById('answer-options');
    const scoreTextElem = document.getElementById('score-text');
    const scoreMessageElem = document.getElementById('score-message');
    const reviewListElem = document.getElementById('review-list');

    let shuffledQuestions, currentQuestionIndex, score, userAnswers;
    const EXAM_LENGTH = 40;
    const USED_QUESTIONS_KEY = 'usedDrivingTestQuestions';

    // Función para comunicarse de forma segura con nuestro back-end
    async function fetchImageFromGemini(prompt) {
        const API_ENDPOINT = '/api/generate-image';
        try {
            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `Error en el servidor: ${response.status}`);
            }
            const data = await response.json();
            return data.svgCode;
        } catch (error) {
            console.error("Error al obtener SVG desde el servidor:", error);
            loadingIndicatorElem.textContent = `Error: ${error.message}.`;
            loadingIndicatorElem.style.color = "red";
            return null;
        }
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function getUsedQuestions() {
        const used = sessionStorage.getItem(USED_QUESTIONS_KEY);
        return used ? JSON.parse(used) : [];
    }

    function setUsedQuestions(questions) {
        const used = getUsedQuestions();
        const newUsed = [...used, ...questions.map(q => q.question)];
        sessionStorage.setItem(USED_QUESTIONS_KEY, JSON.stringify(newUsed));
    }

    function startQuiz() {
        startScreen.style.display = 'none';
        resultsContainer.style.display = 'none';
        quizContainer.style.display = 'block';

        const usedQuestions = getUsedQuestions();
        let availableQuestions = allQuestions.filter(q => !usedQuestions.includes(q.question));

        if (availableQuestions.length < EXAM_LENGTH) {
            sessionStorage.removeItem(USED_QUESTIONS_KEY);
            availableQuestions = allQuestions;
        }

        shuffleArray(availableQuestions);
        shuffledQuestions = availableQuestions.slice(0, EXAM_LENGTH);
        setUsedQuestions(shuffledQuestions);
        
        currentQuestionIndex = 0;
        score = 0;
        userAnswers = [];
        showQuestion();
    }

    async function showQuestion() {
        resetState();
        const currentQuestion = shuffledQuestions[currentQuestionIndex];
        questionCounterElem.textContent = `Pregunta ${currentQuestionIndex + 1} de ${EXAM_LENGTH}`;
        questionTextElem.textContent = currentQuestion.question;

        if (currentQuestion.prompt) {
            imageContainerElem.style.display = 'flex';
            loadingIndicatorElem.textContent = 'Generando imagen con IA, por favor espera...';
            loadingIndicatorElem.style.color = '#007b8a';
            loadingIndicatorElem.style.display = 'block';
            disableOptions(true);

            const svgCode = await fetchImageFromGemini(currentQuestion.prompt);
            
            loadingIndicatorElem.style.display = 'none';
            if (svgCode) {
                imageContainerElem.innerHTML = svgCode;
                currentQuestion.generatedImage = svgCode;
            } else {
                imageContainerElem.innerHTML = '<p style="color:red;">Error al cargar la imagen.</p>';
            }
            disableOptions(false);
        } else {
            imageContainerElem.style.display = 'none';
        }

        currentQuestion.options.forEach(optionText => {
            const optionElement = document.createElement('div');
            optionElement.classList.add('option');
            optionElement.textContent = optionText;
            optionElement.addEventListener('click', () => selectAnswer(optionText, optionElement));
            answerOptionsElem.appendChild(optionElement);
        });
    }

    function disableOptions(disabled) {
        document.querySelectorAll('.option').forEach(option => {
            option.classList.toggle('disabled', disabled);
        });
    }

    function resetState() {
        answerOptionsElem.innerHTML = '';
        imageContainerElem.innerHTML = '<div id="loading-indicator" style="display: none;"></div>';
    }

    function selectAnswer(selectedOptionText, selectedOptionElement) {
        if (document.querySelector('.option.selected')) return;
        selectedOptionElement.classList.add('selected');
        const currentQuestion = shuffledQuestions[currentQuestionIndex];
        const isCorrect = selectedOptionText === currentQuestion.correctAnswer;
        if (isCorrect) score++;
        userAnswers.push({
            question: currentQuestion.question,
            generatedImage: currentQuestion.generatedImage || null,
            userAnswer: selectedOptionText,
            correctAnswer: currentQuestion.correctAnswer,
            isCorrect: isCorrect
        });
        setTimeout(() => {
            currentQuestionIndex++;
            if (currentQuestionIndex < EXAM_LENGTH) {
                showQuestion();
            } else {
                showResults();
            }
        }, 500);
    }

    function showResults() {
        quizContainer.style.display = 'none';
        resultsContainer.style.display = 'block';
        const finalScore = Math.round((score / EXAM_LENGTH) * 100);
        scoreTextElem.textContent = `${finalScore} Puntos`;
        reviewListElem.innerHTML = '';
        if (finalScore >= 70) {
            scoreTextElem.classList.add('score-pass');
            scoreMessageElem.textContent = '¡Felicitaciones, has APROBADO!';
        } else {
            scoreTextElem.classList.add('score-fail');
            scoreMessageElem.textContent = 'Has DESAPROBADO. ¡Sigue practicando!';
        }
        userAnswers.forEach((answer, index) => {
            const li = document.createElement('li');
            li.classList.add(answer.isCorrect ? 'correct' : 'incorrect');
            let reviewHTML = `<div class="question-review">${index + 1}. ${answer.question}</div>`;
            if (answer.generatedImage) {
                reviewHTML += `<div class="review-image-container">${answer.generatedImage}</div>`;
            }
            if (answer.isCorrect) {
                reviewHTML += `<div class="answer-review">✔️ Tu respuesta: ${answer.userAnswer}</div>`;
            } else {
                reviewHTML += `<div class="answer-review">❌ Tu respuesta: ${answer.userAnswer}</div>`;
                reviewHTML += `<div class="answer-review">Respuesta correcta: ${answer.correctAnswer}</div>`;
            }
            li.innerHTML = reviewHTML;
            reviewListElem.appendChild(li);
        });
    }

    startBtn.addEventListener('click', startQuiz);
    restartBtn.addEventListener('click', startQuiz);
</script>
</body>
</html>