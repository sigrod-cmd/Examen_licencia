<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Online con IA - Examen de Conducir Argentina</title>
    <style>
        /* (LOS ESTILOS CSS SON LOS MISMOS QUE EN LA RESPUESTA ANTERIOR, LOS INCLUYO PARA QUE SEA COMPLETO) */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        body { font-family: 'Roboto', sans-serif; background-color: #f0f4f8; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background-color: #ffffff; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); width: 100%; max-width: 800px; padding: 30px; box-sizing: border-box; }
        .header { text-align: center; border-bottom: 2px solid #00a1b2; padding-bottom: 20px; margin-bottom: 20px; }
        .header h1 { color: #005a7d; margin: 0; }
        #start-screen, #results-container { text-align: center; }
        #start-screen p { font-size: 1.1em; line-height: 1.6; }
        #start-btn, #restart-btn { background-color: #00a1b2; color: white; border: none; padding: 15px 30px; font-size: 1.2em; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; margin-top: 20px; }
        #start-btn:hover, #restart-btn:hover { background-color: #007b8a; }
        #quiz-container { display: none; }
        #question-counter { font-size: 1em; font-weight: 500; color: #555; margin-bottom: 15px; }
        #image-container { min-height: 200px; max-height: 250px; display: flex; justify-content: center; align-items: center; margin: 15px auto; border: 1px dashed #ccc; border-radius: 8px; padding: 10px; }
        #image-container svg { max-width: 100%; max-height: 200px; }
        #loading-indicator { font-style: italic; color: #007b8a; }
        #question-text { font-size: 1.4em; font-weight: 700; margin-bottom: 25px; }
        #answer-options { display: flex; flex-direction: column; gap: 15px; }
        .option { background-color: #f8f9fa; border: 2px solid #dee2e6; padding: 15px; border-radius: 5px; cursor: pointer; transition: all 0.2s; text-align: left; }
        .option.disabled { pointer-events: none; opacity: 0.7; }
        .option:hover:not(.disabled) { background-color: #e9ecef; border-color: #00a1b2; }
        .option.selected { background-color: #d1ecf1; border-color: #007b8a; font-weight: 500; }
        #results-container { display: none; }
        #score-text { font-size: 2.5em; font-weight: 700; margin-bottom: 20px; }
        .score-pass { color: #28a745; }
        .score-fail { color: #dc3545; }
        #review-list { list-style: none; padding: 0; text-align: left; max-height: 400px; overflow-y: auto; }
        #review-list li { background-color: #f8f9fa; border-radius: 5px; padding: 15px; margin-bottom: 10px; border-left: 5px solid; }
        #review-list li.correct { border-color: #28a745; }
        #review-list li.incorrect { border-color: #dc3545; }
        .question-review { font-weight: bold; margin-bottom: 8px; }
        .answer-review { margin-top: 8px; }
        .review-image-container { max-width: 150px; margin-top: 10px; }
        .review-image-container svg { width: 100%; height: auto; border-radius: 5px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Simulador Online con IA - Examen de Conducir</h1>
            <p>Basado en el Curso Nacional de Educación Vial Digital</p>
        </div>
        <div id="start-screen">
            <h2>¡Listo para practicar!</h2>
            <p>
                Este examen consta de 40 preguntas aleatorias de un banco de más de 80. Las imágenes se generarán al instante usando la IA de Gemini.
                <br>¡Mucha suerte!
            </p>
            <button id="start-btn">Comenzar Examen</button>
        </div>
        <div id="quiz-container">
            <div id="question-counter"></div>
            <div id="image-container">
                <div id="loading-indicator" style="display: none;"></div>
            </div>
            <div id="question-text"></div>
            <div id="answer-options"></div>
        </div>
        <div id="results-container">
            <h2>Resultados del Examen</h2>
            <div id="score-text"></div>
            <p id="score-message"></p>
            <h3>Revisión de Respuestas</h3>
            <ul id="review-list"></ul>
            <button id="restart-btn">Intentar Nuevo Examen</button>
        </div>
    </div>
<script>
const allQuestions = [
    // --- Banco de Preguntas con Prompts para la IA ---
    // (Aquí va todo el array 'allQuestions' que te proporcioné en la respuesta anterior.
    // Es muy largo, así que lo omito aquí para no hacer esta respuesta gigante, pero
    // debes asegurarte de que esté completo en tu archivo)
    {
        question: "La señal que se muestra, ¿qué indica?",
        prompt: "Generate the clean SVG code for a 'Contramano' (No Entry) traffic sign. It should be a red circle with a white horizontal rectangle in the center. Argentinian road sign style. The SVG should be responsive.",
        options: ["Giro obligatorio", "Prohibición de avanzar (Contramano)", "Calle sin salida", "Estacionamiento exclusivo"],
        correctAnswer: "Prohibición de avanzar (Contramano)"
    },
    // ... Y así sucesivamente con TODAS las preguntas.
    {
        question: "Si un semáforo cambia de verde a amarillo, usted debe:",
        options: ["Acelerar para cruzar antes de que se ponga en rojo", "Detenerse, si es posible hacerlo con seguridad, antes de la línea de cruce", "Continuar la marcha normalmente", "Frenar bruscamente sin importar el vehículo de atrás"],
        correctAnswer: "Detenerse, si es posible hacerlo con seguridad, antes de la línea de cruce"
    }
];

const startScreen = document.getElementById('start-screen');
const quizContainer = document.getElementById('quiz-container');
// ... (El resto del script hasta la función fetch) ...

const scoreTextElem = document.getElementById('score-text');
const scoreMessageElem = document.getElementById('score-message');
const reviewListElem = document.getElementById('review-list');
let shuffledQuestions, currentQuestionIndex, score, userAnswers;
const EXAM_LENGTH = 40;

// *** ESTA ES LA FUNCIÓN MODIFICADA Y CORRECTA PARA EL MODO ONLINE ***
async function fetchImageFromGemini(prompt) {
    // 1. Llama a NUESTRO propio servidor en una ruta específica.
    const API_ENDPOINT = '/api/generate-image'; 

    try {
        const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            // 2. Le envía el "prompt" al servidor para que él haga el trabajo.
            body: JSON.stringify({ prompt: prompt }) 
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `Error en el servidor: ${response.status}`);
        }

        const data = await response.json();
        // 3. Recibe el código SVG ya listo para mostrar.
        return data.svgCode;

    } catch (error) {
        console.error("Error al obtener SVG desde el servidor:", error);
        loadingIndicatorElem.textContent = `Error: ${error.message}.`;
        loadingIndicatorElem.style.color = "red";
        return null;
    }
}

// ... (Aquí sigue el resto del código JavaScript sin cambios) ...
function shuffleArray(array) { /* ... */ }
function startQuiz() { /* ... */ }
async function showQuestion() {
    resetState();
    const currentQuestion = shuffledQuestions[currentQuestionIndex];
    questionCounterElem.textContent = `Pregunta ${currentQuestionIndex + 1} de ${EXAM_LENGTH}`;
    questionTextElem.textContent = currentQuestion.question;

    imageContainerElem.style.display = 'none';
    if (currentQuestion.prompt) {
        imageContainerElem.style.display = 'flex';
        loadingIndicatorElem.textContent = 'Generando imagen con IA, por favor espera...';
        loadingIndicatorElem.style.color = '#007b8a';
        loadingIndicatorElem.style.display = 'block';
        disableOptions(true);

        const svgCode = await fetchImageFromGemini(currentQuestion.prompt);
        
        if (svgCode) {
            loadingIndicatorElem.style.display = 'none';
            imageContainerElem.innerHTML = svgCode; // Usamos innerHTML para renderizar el SVG
            currentQuestion.generatedImage = svgCode;
        }
        disableOptions(false);
    } 

    currentQuestion.options.forEach(optionText => {
        const optionElement = document.createElement('div');
        optionElement.classList.add('option');
        optionElement.textContent = optionText;
        optionElement.addEventListener('click', () => selectAnswer(optionText, optionElement));
        answerOptionsElem.appendChild(optionElement);
    });
}
function disableOptions(disabled) { /* ... */ }
function resetState() { /* ... */ }
function selectAnswer(selectedOptionText, selectedOptionElement) { /* ... */ }
function showResults() { /* ... */ }

startBtn.addEventListener('click', startQuiz);
restartBtn.addEventListener('click', startQuiz);

</script>
</body>
</html>